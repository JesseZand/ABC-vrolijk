<!DOCTYPE html>
<html lang="nl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>ABC Vrolijk (NL)</title>
  <meta name="theme-color" content="#ffd54f" />
  <style>
    :root{
      --bg1:#fef3c7; --bg2:#fde68a;
      --letter-color:#ef4444; --muted:#6b7280;
      --card-bg:rgba(255,255,255,.9); --shadow:0 10px 30px rgba(0,0,0,.08);
      --tap:48px;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0; font-family: Arial, Helvetica, sans-serif; -webkit-font-smoothing:antialiased;
      color:#111827; background: linear-gradient(180deg,var(--bg1),var(--bg2));
      display:flex; align-items:center; justify-content:center;
    }
    .app{width:100%; max-width:560px; padding:clamp(12px,3vw,20px)}
    .topbar{display:flex; align-items:center; justify-content:space-between; gap:8px; margin-bottom:12px;}
    .brand{font-weight:700; letter-spacing:.2px}
    .settings{display:flex; align-items:center; gap:8px; color:var(--muted); font-size:14px;}
    select{padding:8px 10px; border-radius:12px; border:1px solid #e5e7eb; background:#fff;}
    .card{
      background:var(--card-bg); border-radius:24px; box-shadow:var(--shadow);
      padding:24px; display:flex; flex-direction:column; align-items:center; gap:16px;
      min-height:62vh; justify-content:center;
    }
    .letter{font-size: clamp(86px, 25vw, 200px); line-height:1; font-weight:700; color:var(--letter-color); text-align:center;}
    .letter.small{font-size: clamp(64px, 14vw, 120px)}
    .both{display:flex; gap:.3em; align-items:baseline}
    .lower{opacity:.65}
    .bounce{animation:bounce .35s cubic-bezier(.2,.7,.3,1.2)}
    @keyframes bounce{0%{transform:translateY(0) scale(1)}35%{transform:translateY(-10px) scale(1.04)}100%{transform:translateY(0) scale(1)}}
    .example{width:100%; max-width:440px; text-align:center;}
    .example img{width:100%; height:auto; border-radius:20px; box-shadow:var(--shadow); background:#fff;}
    .example .name{font-size: clamp(28px, 6vw, 42px); font-weight:700; color:#111827; padding:18px 14px; border-radius:16px; background:#fff; box-shadow:var(--shadow);}
    .controls{display:flex; gap:12px; margin-top:8px; justify-content:center;}
    .btn{
      min-width:120px; height:var(--tap); display:inline-flex; align-items:center; justify-content:center; gap:8px;
      background:#111827; color:#fff; border:none; border-radius:999px; font-weight:700; box-shadow:var(--shadow); font-size:16px;
    }
    .btn.secondary{background:#374151}
    .btn:active{transform:translateY(1px)}
    .muted{color:var(--muted); font-size:14px; text-align:center; margin-top:8px}
    .start{position:fixed; inset:0; background:linear-gradient(180deg,#e0f2fe,#fef3c7); display:flex; align-items:center; justify-content:center; padding:20px; z-index:20;}
    .start .panel{background:#fff; border-radius:28px; box-shadow:var(--shadow); padding:26px; text-align:center; max-width:520px;}
    .celebrate{position:fixed; inset:0; background:rgba(0,0,0,.35); display:none; align-items:center; justify-content:center; z-index:30; padding:20px;}
    .celebrate .panel{background:#fff; border-radius:28px; box-shadow:var(--shadow); padding:26px; text-align:center; width:100%; max-width:420px;}
    .sticker{width:min(240px,60vw); height:min(240px,60vw); background:#fff; border-radius:32px; margin:0 auto 16px; display:flex; align-items:center; justify-content:center; overflow:hidden; box-shadow:var(--shadow);}
    .sticker img{width:100%; height:100%; object-fit:contain}
    .hidden{display:none}
    .sr-only{position:absolute;width:1px;height:1px;padding:0;margin:-1px;overflow:hidden;clip:rect(0,0,0,0);white-space:nowrap;border:0}
    @media (prefers-reduced-motion: reduce){ .bounce{animation:none} }
    @media (max-width: 600px) {
      .letter {
      font-size: clamp(100px, 30vw, 240px);
      }
    }
  </style>
</head>
<body>
  <div class="app" role="application" aria-label="ABC Vrolijk">
    <div class="topbar" aria-hidden="false">
      <div class="brand">üü† ABC Vrolijk</div>
      <div class="settings">
        Lettervorm:
        <label class="sr-only" for="caseSel">Lettervorm</label>
        <select id="caseSel" aria-label="Kies lettervorm">
          <option value="UPPERCASE" selected>Hoofdletters</option>
          <option value="LOWERCASE">Kleine letters</option>
          <option value="BOTH">Beide</option>
        </select>
      </div>
    </div>

    <main class="card" id="card" aria-live="polite">
      <div id="letter" class="letter" aria-label="Letter">A</div>

      <div class="example" id="example"></div>

      <div class="controls">
        <button class="btn" id="pauseBtn" type="button" aria-pressed="false">‚è∏Ô∏è Pauze</button>
        <button class="btn secondary" id="repeatBtn" type="button">üîÅ Herhaal</button>
        <button class="btn" id="nextBtn" type="button" disabled>‚û°Ô∏è Volgende letter</button>
      </div>
      <div class="muted">Hi Nina! Leer zo het alfabet met leuke plaatjes</div>
    </main>
  </div>

  <!-- Start Gate -->
  <div class="start" id="gate">
    <div class="panel">
      <h1 style="margin:0 0 8px">Welkom bij <strong>ABC Vrolijk</strong> üéâ</h1>
      <p style="margin:0 0 18px;color:#374151">Tik op Start om geluiden en spraak te activeren.</p>
      <button class="btn" id="startBtn">‚ñ∂Ô∏è Start</button>
    </div>
  </div>

  <!-- Celebrate Modal -->
  <div class="celebrate" id="celebrate">
    <div class="panel">
      <h2 style="margin:0 0 12px">Goed gedaan! üåü</h2>
      <div class="sticker"><img id="stickerImg" alt="Vrolijk dier sticker" src="" /></div>
      <button class="btn" id="moreBtn">Nog 5 letters</button>
    </div>
  </div>

<script>
/* ------------------------- Content & Config ------------------------- */
const LETTERS = ["A","B","C","D","E","F","G","H","I","J","K","L","M","N","O","P","Q","R","S","T","U","V","W","X","IJ","Z"];
const WEIGHTS = {
  // Common ones ‚Üí lower weight
  A:1, E:1, N:1, O:1, I:1, T:1,
  // Medium
  D:2, R:2, S:2, K:2, L:2, M:2,
  // Rare ‚Üí higher weight
  B:3, C:3, F:3, G:3, H:3, J:3, P:3, U:3, V:3, W:3, Z:3,
  // Very rare ‚Üí highest weight
  Q:5, X:5, IJ:5,
};
const WORD_LIST = {
  A:[{word:"appel"},{word:"auto"},{word:"Apollo",isName:true}],
  B:[{word:"bal"},{word:"boom"}],
  C:[{word:"cirkel"},{word:"camera"}],
  D:[{word:"druif"},{word:"dino"}],
  E:[{word:"eend"},{word:"ei"}],
  F:[{word:"fiets"},{word:"fles"}],
  G:[{word:"geit"},{word:"giraffe"}],
  H:[{word:"huis"},{word:"hoed"}],
  I:[{word:"inkt"},{word:"insect"}],
  J:[{word:"jas"},{word:"jurk"},{word:"Jesse",isName:true}],
  K:[{word:"kast"},{word:"kikker"}],
  L:[{word:"leeuw"},{word:"lamp"},{word:"Leo",isName:true}],
  M:[{word:"muis"},{word:"maan"},{word:"mama", isName:true},{word:"Misha",isName:true}],
  N:[{word:"neus"},{word:"noot"},{word:"Nina",isName:true},{word:"Nina",isName:true}],
  O:[{word:"olifant"},{word:"oog"},{word:"oma"},{word:"opa"}],
  P:[{word:"poes"},{word:"peer"},{word:"papa", isName:true}],
  Q:[{word:"quiz"},{word:"queer"}],
  R:[{word:"rat"},{word:"regen"}],
  S:[{word:"slang"},{word:"schaap"},{word:"Sof√≠a",isName:true}, {word:"Steffie",isName:true}],
  T:[{word:"tijger"},{word:"trein"},{word:"Tio",isName:true}],
  U:[{word:"uil"},{word:"ui"}],
  V:[{word:"vogel"},{word:"varken"}],
  W:[{word:"walvis"},{word:"wolk"}],
  X:[{word:"xylofoon"}],
  IJ:[{word:"ijsbeer"},{word:"ijsje"}],
  Z:[{word:"zebra"},{word:"zon"}]
};

const QUESTIONS = [
  "Welke letter is dit?",
  "Weet jij welke letter dit is?",
  "Welke letter hoor je hier?"
];

const COLORS = [
  ["#dbeafe","#bfdbfe"], ["#fde68a","#fcd34d"], ["#c7d2fe","#a5b4fc"],
  ["#fecaca","#fca5a5"], ["#bbf7d0","#86efac"], ["#fbcfe8","#f9a8d4"],
  ["#e9d5ff","#d8b4fe"], ["#fee2e2","#fecaca"]
];
const LETTER_COLORS = ["#ef4444","#10b981","#3b82f6","#f59e0b","#8b5cf6","#22c55e","#e11d48","#0ea5e9"];

/* ----------------------------- State ------------------------------- */
let state = {
  letterCase: "UPPERCASE",
  step: "ASK",
  currentLetter: "A",
  shownInSet: 0,
  paused: false,
  voicesReady: false,
  lastSpoken: "",
  colorIndex: 0,
  nextGate: null,   // { promise, cleanup } or null
};

/* ------------------------------ DOM -------------------------------- */
const elLetter = document.getElementById("letter");
const elExample = document.getElementById("example");
const elPause = document.getElementById("pauseBtn");
const elRepeat = document.getElementById("repeatBtn");
const elCase = document.getElementById("caseSel");
const elGate = document.getElementById("gate");
const elStart = document.getElementById("startBtn");
const elCelebrate = document.getElementById("celebrate");
const elMore = document.getElementById("moreBtn");
const elSticker = document.getElementById("stickerImg");
const card = document.getElementById("card");
const elNext = document.getElementById("nextBtn");
let praiseTimer = null;   // holds the timeout for the praise line


/* -------------------------- Audio (SFX) ---------------------------- */
const chimeStart = new Audio("assets/sfx/chime_start.mp3");
const chimeSuccess = new Audio("assets/sfx/chime_success.mp3");
const jingles = [
  new Audio("assets/sfx/jingle1.mp3"),
  new Audio("assets/sfx/jingle2.mp3"),
  new Audio("assets/sfx/jingle3.mp3")
];
chimeStart.preload = "auto"; 
chimeSuccess.preload = "auto";
jingles.forEach(j => j.preload = "auto");

/* ------------------------------ TTS -------------------------------- */
let selectedVoice = null;
console.log("Selected voice:", selectedVoice && selectedVoice.name, selectedVoice && selectedVoice.lang);

function refreshVoices(){
  const vs = speechSynthesis.getVoices().filter(v=> (v.lang||"").toLowerCase().startsWith("nl"));
  selectedVoice = vs.find(v=>/female|vrouw/i.test(v.name)) || vs[0] || null;
  state.voicesReady = true;
}
speechSynthesis.onvoiceschanged = refreshVoices;
refreshVoices();

function speak(text, {rate=1.0, pitch=1.1} = {}){
  try{
    const u = new SpeechSynthesisUtterance(text);
    u.lang = "nl-NL";

    // Add small random variation
    u.rate = rate + (Math.random() * 0.05 - 0.025);  // +/-0.025
    u.pitch = pitch + (Math.random() * 0.05 - 0.025);

    if(selectedVoice) u.voice = selectedVoice;
    speechSynthesis.speak(u);
  }catch(e){}
}

function speakAsync(text, {rate=0.9, pitch=0.95} = {}){
  return new Promise(resolve=>{
    try{
      const u = new SpeechSynthesisUtterance(text);
      u.lang = "nl-NL"; u.rate = rate; u.pitch = pitch;
      if(selectedVoice) u.voice = selectedVoice;
      u.onend = resolve;
      u.onerror = resolve;   // resolve even on error
      speechSynthesis.speak(u);
    }catch(e){ resolve(); }
  });
}

function vibrate(ms=10){ try{ navigator.vibrate && navigator.vibrate(ms); }catch{} }

/* --------------------------- Utilities ----------------------------- */
function weightedPick(){
  const total = Object.values(WEIGHTS).reduce((a,b)=>a+b,0);
  let r = Math.random()*total;
  for(const L of LETTERS){ r -= WEIGHTS[L]; if(r<=0) return L; }
  return "E";
}
function letterName(L){
  // Standaard Nederlandse letternamen
  const names = {
    A:"√°",  B:"b", C:"c", D:"d", E:"√©",
    F:"f",  G:"g", H:"h", I:"i",  J:"j",
    K:"k", L:"el",  M:"m",  N:"n",  O:"o",
    P:"p", Q:"k", R:"r",  S:"s",  T:"t",
    U:"√∫",  V:"v", W:"w", X:"iks",
    IJ:"ij", Z:"zet"
  };
  return names[L] || L;
}
function waitOrNext(ms){
  return new Promise(resolve=>{
    let remaining = ms;
    let last = Date.now();

    function tick(){
      // if paused, don‚Äôt count time down
      if (state.paused) {
        last = Date.now();
        setTimeout(tick, 50);
        return;
      }
      const now = Date.now();
      remaining -= (now - last);
      last = now;

      if (remaining <= 0) resolve();
      else setTimeout(tick, 50); // keep ticking until time is up
    }

    setTimeout(tick, 50);
  });
}
async function ensureDutchVoice(timeoutMs = 2000){
  const deadline = Date.now() + timeoutMs;

  return new Promise(resolve => {
    function select(){
      const vs = speechSynthesis.getVoices();
      if (vs.length === 0 && Date.now() < deadline) {
        setTimeout(select, 100);
        return;
      }
      const nl = vs.filter(v => /^nl([-_]|$)/i.test(v.lang || ""));
      // Prefer ‚Äúbetter‚Äù engines if present
      selectedVoice =
        nl.find(v => /Google|Microsoft|Apple/i.test(v.name)) ||
        nl[0] || null;

      state.voicesReady = !!selectedVoice;
      resolve(selectedVoice);
    }
    select();
  });
}

// Race any promise (like speakAsync) with the Next gate
function raceNext(promise){
  return state.nextGate ? Promise.race([promise, state.nextGate.promise]) : promise;
}

// (Keep this as a function declaration so it's hoisted)
function waitOrPause(ms){
  return new Promise(resolve=>{
    let remaining = ms;
    let last = Date.now();

    function tick(){
      if (state.paused) {
        last = Date.now();
        setTimeout(tick, 50);
        return;
      }
      const now = Date.now();
      remaining -= (now - last);
      last = now;

      if (remaining <= 0) resolve();
      else setTimeout(tick, 50);
    }

    setTimeout(tick, 50);
  });
}

function randomChoice(arr){ return arr[Math.floor(Math.random()*arr.length)]; }
function setGradientAndColor(){
  state.colorIndex = (state.colorIndex + 1) % COLORS.length;
  const [g1,g2] = COLORS[state.colorIndex];
  const letterColor = LETTER_COLORS[state.colorIndex % LETTER_COLORS.length];
  document.documentElement.style.setProperty("--bg1", g1);
  document.documentElement.style.setProperty("--bg2", g2);
  document.documentElement.style.setProperty("--letter-color", letterColor);
}

function randomPraise(){
  return [
    "Goed zo!",      // split-intonation
    "Knap hoor!",    // split-intonation
    "Topper!",
    "Wat knap!",
    "Mooi gedaan!"
  ][Math.floor(Math.random()*5)];
}

function sayLetterForTTS(L){
  // Always return the Dutch letter name string; lowercase keeps it natural
  const names = {
    A:"√°",  B:"b", C:"c", D:"d", E:"√©",
    F:"f",  G:"g", H:"h", I:"i",  J:"j",
    K:"k", L:"el",  M:"m",  N:"n",  O:"o",
    P:"p", Q:"k", R:"r",  S:"s",  T:"t",
    U:"√∫",  V:"v", W:"w", X:"iks",
    IJ:"ij", Z:"zet"
  };
  return (names[L] || L).toLowerCase();
}

async function speakPraise(text){
  const t = text.toLowerCase().trim();

 if (t.startsWith("goed zo")) {
  if (await raceNext (speakAsync("Goed zo!", { rate: 1.05, pitch: 1.18 }))=== "NEXT");
  return;
}

  if (t.startsWith("knap hoor")) {
  if (await raceNext (speakAsync("Knap hoor!", { rate: 1.05, pitch: 1.18 }))=== "NEXT");
  return;
}

  // default: one-shot
  if (await raceNext (speakAsync(text, { rate: 1.05, pitch: 1.20 }))=== "NEXT");
}

function nameForSentence(L){
  // Use Dutch names, all lowercase, to prevent the TTS from spelling/anglicizing
  const names = {
     A:"√°",  B:"b", C:"c", D:"d", E:"√©",
    F:"f",  G:"g", H:"h", I:"i",  J:"j",
    K:"k", L:"el",  M:"m",  N:"n",  O:"o",
    P:"p", Q:"k", R:"r",  S:"s",  T:"t",
    U:"√∫",  V:"v", W:"w", X:"iks",
    IJ:"ij", Z:"zet"
  };
  return (names[L] || L).toLowerCase();
}

function armNextGate(delayMs = 0){
  // Clean previous gate if any
  if (state.nextGate?.cleanup) state.nextGate.cleanup();

  let resolveFn;
  const promise = new Promise(res => (resolveFn = res));

  let enableTimer = null;

  const handler = () => {
    vibrate();

    // Stop any pending praise or speech immediately
    if (praiseTimer) { clearTimeout(praiseTimer); praiseTimer = null; }
    try { speechSynthesis.cancel(); } catch {}

    elNext.disabled = true; // prevent double taps
    elNext.removeEventListener("click", handler);
    resolveFn("NEXT");      // signal skip
  };

  // Keep disabled until the delay has passed
  elNext.disabled = true;

  const enable = () => {
    elNext.disabled = false;
    // Add once so we never get duplicate handlers
    elNext.addEventListener("click", handler, { once: true });
  };

  if (delayMs > 0) {
    enableTimer = setTimeout(enable, delayMs);
  } else {
    enable();
  }

  state.nextGate = {
    promise,
    cleanup: () => {
      if (enableTimer) clearTimeout(enableTimer);
      elNext.removeEventListener("click", handler);
    },
  };
  return state.nextGate;
}


// Race a pause with the user pressing Next
function waitOrNext(ms){
  return state.nextGate
    ? Promise.race([ waitOrPause(ms), state.nextGate.promise ])
    : waitOrPause(ms);
}


/* ---------------------------- Rendering ---------------------------- */
function renderLetter(){
  const L = state.currentLetter;
  const upper = L;
  const lower = (L==="IJ") ? "ij" : L.toLowerCase();

  elLetter.classList.remove("small");
  if(state.letterCase === "UPPERCASE"){
    elLetter.textContent = upper;
    elLetter.setAttribute("aria-label", `Letter ${upper}`);
  } else if(state.letterCase === "LOWERCASE"){
    elLetter.textContent = lower;
    elLetter.setAttribute("aria-label", `Letter ${lower}`);
  } else {
    elLetter.classList.add("small");
    elLetter.innerHTML = `<span class="both"><span>${upper}</span><span class="lower">${lower}</span></span>`;
    elLetter.setAttribute("aria-label", `Letter ${upper} ${lower}`);
  }
}
function renderExample(opt){
  elExample.innerHTML = "";
  if(opt?.isName){
    const div = document.createElement("div");
    div.className = "name";
    div.textContent = opt.word;
    elExample.appendChild(div);
  } else {
    const img = document.createElement("img");
    const folder = state.currentLetter;
    const filename = opt.word.toLowerCase().replaceAll(" ", "_") + ".png";
    img.alt = opt.word;
    img.src = `assets/words/${folder}/${filename}`;
    img.onerror = () => { elExample.innerHTML = `<div class="name">${opt.word}</div>`; };
    elExample.appendChild(img);
  }
}
function bounceLetter(){
  elLetter.classList.remove("bounce");
  void elLetter.offsetWidth;
  elLetter.classList.add("bounce");
}

/* ---------------------------- Celebrate ---------------------------- */
const STICKER_COUNT = 6; // you currently have 6: animal_01..animal_06

function showCelebrate(){
  // prevent skip while modal is up
  elNext.disabled = true;
  if (state.nextGate?.cleanup) state.nextGate.cleanup();

  const n = Math.floor(Math.random()*6)+1;
  elSticker.src = `assets/stickers/animal_${String(n).padStart(2,"0")}.png`;
  elCelebrate.style.display = "flex";

  const j = jingles[Math.floor(Math.random()*jingles.length)];
  try { j.currentTime = 0; j.play(); } catch(e) { console.warn("Jingle play failed", e); }
}

function hideCelebrate(){
  elCelebrate.style.display = "none";
  armNextGate(); // re-enable skipping as soon as we‚Äôre back
}

/* ---------------------------- Main Loop ---------------------------- */
async function runLesson(){
  let spoken = "";
  for(;;){
    if(state.shownInSet >= 5){
      state.step = "CELEBRATE";
      showCelebrate();
      await new Promise(res=> elMore.onclick = () => { vibrate(); hideCelebrate(); res(); });
      state.shownInSet = 0;
    }

    // New letter + palette
    state.currentLetter = weightedPick();
    setGradientAndColor();
    renderLetter();
    elExample.innerHTML = "";
    elNext.disabled = true;

    // ASK
    if (praiseTimer) { clearTimeout(praiseTimer); praiseTimer = null; }
    try { speechSynthesis.cancel(); } catch {}
    state.step = "ASK";
    try { chimeStart.currentTime = 0; chimeStart.play(); } catch {}
    const q = randomChoice(QUESTIONS);

    if (await raceNext (speakAsync(q, { rate: 0.98, pitch: 1.20 }))=== "NEXT");  // more lively, rising intonation
    if (await waitOrNext(4000)=== "NEXT");

    // REVEAL
    state.step = "REVEAL_LETTER";
    bounceLetter();
    armNextGate(3000); // <‚Äî enable ‚ÄúNext‚Äù only after 3s of showing the letter
    try{ chimeSuccess.currentTime = 0; chimeSuccess.play(); }catch{}
    if (await waitOrNext(200)=== "NEXT");                       // a bit more room after the chime
    const spoken  = letterName(state.currentLetter); // for UI/text if you like
    const literal = state.currentLetter;             // the raw letter
    const say     = sayLetterForTTS(state.currentLetter); // what we actually speak

    // Store what to repeat (still the full phrase)
    state.lastSpoken = `De letter ${say}!`;

    // Speak in two parts: normal intro, then emphasised letter
    if (await raceNext (speakAsync("De letter", { rate: 0.96, pitch: 1.02 }))=== "NEXT");
    if (await waitOrNext(150)=== "NEXT"); // tiny pause so it doesn‚Äôt run together
    if (await raceNext (speakAsync(`${say}`, { rate: 0.96, pitch: 1.09 }))=== "NEXT"); // slightly higher pitch


    if (await waitOrNext(700)=== "NEXT");
    if (await raceNext (speakAsync(`${say}`, { rate: 0.99, pitch: 1.02 }))=== "NEXT");

    if (await waitOrNext(800)=== "NEXT");
    if (await raceNext (speakAsync(`${say}`, { rate: 0.85, pitch: 1.02 }))=== "NEXT");



    // EXAMPLE
    state.step = "EXAMPLE_WORD";
    const opt = randomChoice(WORD_LIST[state.currentLetter]);
    renderExample(opt);

    if (await waitOrNext(500)=== "NEXT");
    const letterNL = nameForSentence(state.currentLetter);
    if (await raceNext (speakAsync(`de ${letterNL} van ${opt.word}.`, { rate: 0.95, pitch: 0.98 }))=== "NEXT");

    if (await waitOrNext(400)=== "NEXT");
    if (await raceNext (speakAsync(`${opt.word}.`, { rate: 0.95, pitch: 0.98 }))=== "NEXT");
    // een kleine extra aanmoediging na ~0.4s
    if (praiseTimer) { clearTimeout(praiseTimer); }
    praiseTimer = setTimeout(async () => {
      try { speechSynthesis.cancel(); } catch {}
      const p = randomPraise();
      state.lastSpoken = p;           // so the Repeat button can replay it if you like
      await speakPraise(p);           // <- uses the split-intonation rules above
      praiseTimer = null;
    }, 500);
    await waitOrNext(100000);
    state.shownInSet++;
  }
}

/* --------------------------- Controls ------------------------------ */
elCase.addEventListener("change", (e)=>{ state.letterCase = e.target.value; renderLetter(); vibrate(); });
elPause.addEventListener("click", ()=>{
  state.paused = !state.paused;
  elPause.textContent = state.paused ? "‚ñ∂Ô∏è Verder" : "‚è∏Ô∏è Pauze";
  elPause.setAttribute("aria-pressed", String(state.paused));
  vibrate();
  if (!state.paused) {
  // Only auto-replay when we‚Äôre NOT in ASK
  if (state.step !== "ASK" && state.lastSpoken) {
    speak(state.lastSpoken);
  }
} else {
  try { speechSynthesis.cancel(); } catch {}
}
});
elRepeat.addEventListener("click", ()=>{
  vibrate();
  if(state.lastSpoken){
    if(state.step!=="ASK"){ try{ chimeSuccess.currentTime=0; chimeSuccess.play(); }catch{} }
    speak(state.lastSpoken);
  }
});

/* --------------- Start gate (audio unlock + kickoff) --------------- */
document.getElementById("startBtn").addEventListener("click", async ()=>{
  vibrate();
  try{ await chimeStart.play(); chimeStart.pause(); chimeStart.currentTime=0; }catch{}
  try{ await chimeSuccess.play(); chimeSuccess.pause(); chimeSuccess.currentTime=0; }catch{}
  await ensureDutchVoice(1500);
  document.getElementById("gate").classList.add("hidden");
  setTimeout(()=> runLesson(), 100);
});

/* ------------------------ First paint defaults --------------------- */
renderLetter();
setGradientAndColor();
</script>
</body>
</html>
